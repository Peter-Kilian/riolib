name: CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        standard: [c89, c99, c11, c17]

        exclude:
          - os: macos-latest
            compiler: gcc

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show compiler version
        run: |
          echo "Using compiler: ${{ matrix.compiler }}"
          ${{ matrix.compiler }} --version

      - name: Build each test directory separately
        run: |
          set -euo pipefail

          mkdir -p build

          for dir in tests/*/; do
            if [ ! -d "$dir" ]; then continue; fi

            name=$(basename "$dir")
            echo "Building test: $name ..."

            ${{ matrix.compiler }} \
              -std=${{ matrix.standard }} \
              -Wall -Wextra -Wpedantic -Werror \
              -Wconversion -Wshadow -Wstrict-prototypes \
              -I. \
              "$dir"/*.c \
              -o "build/$name"

            echo "Built: build/$name"
          done

      - name: Run all built tests
        run: |
          set -euo pipefail

          found=false

          for exe in build/*; do
            if [ ! -x "$exe" ]; then continue; fi

            found=true
            echo ""
            echo "────────────────────────────────────────"
            echo "Running $(basename "$exe") ..."
            echo "────────────────────────────────────────"

            ./"$exe" || {
              echo "Test $(basename "$exe") failed!"
              exit 1
            }
          done

          if [ "$found" = false ]; then
            echo "Error: No test executables were built in ./build/"
            ls -la build/ || true
            exit 1
          fi

          echo "All tests passed."
